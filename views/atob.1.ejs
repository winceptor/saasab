<!-- views/directions.ejs -->

<% var currenttrip = false; if (apiresponse && apiresponse.result && apiresponse.result.routes && apiresponse.result.routes[0]) { var currenttrip = apiresponse.result.routes[0].legs[0]; }%>

<% layout('layout') -%>
    
<div style="display: none;">
    <span><%=  JSON.stringify(apiresponse)  %></span>
</div>


<% include /directionsinput %>


<div class="container">   
    <div class="page-header">
        <% if (currenttrip) { %><h2>Distance: <span class="bold"><%= currenttrip.distance.text %></span></h2><% } %>
        <% if (apiresponse && apiresponse.result && apiresponse.result.emissions) { %><h2>CO2-Emissions: <span class="bold"><%= apiresponse.result.emissions %> g</span></h2><% } %>
    </div>
</div>

<div class="container">
    <div class="row">
        <form id="carpooling_form" class="form-horizontal" method="post" action="carpool_new">
            <div class="col-xs-6">
                <select id="tripslist" name="trip" class="selectpicker form-control" title="Selected trip">
                    <% if (currenttrip) { %>
                        <option selected="selected" value="">My trip</option>
                    <% } else { %>
                        <option selected="selected" value="">Error</option>
                    <% } %>
                    <% if (apiresponse.status=="success") { var trips = apiresponse.result.trips; %>
            			<% for(var k in trips){ var gpscoords = trips[k].origin.lat + "," + trips[k].origin.long + ";" + trips[k].destination.lat + "," + trips[k].destination.long; %>
            				<option value="<%= trips[k].id %>" gps="<%= gpscoords %>"><%= "(" + trips[k].origin.name + ") -> (" + trips[k].destination.name + ")" %></option>
            			<% } %>
            		<% } %>
    		    </select>
            </div>
            
            <div class="col-xs-6">
                <% if (currenttrip) { %>
                    <input type="hidden" name="origin" value="<%= currenttrip.start_address %>" class="form-control">
    				<input type="hidden" name="destination" value="<%= currenttrip.end_address %>" class="form-control">
    				
    				<input type="hidden" name="originlat" value="<%= currenttrip.start_location.lat %>" class="form-control">
    				<input type="hidden" name="originlong" value="<%= currenttrip.start_location.lng %>" class="form-control">
    				<input type="hidden" name="destinationlat" value="<%= currenttrip.end_location.lat %>" class="form-control">
    				<input type="hidden" name="destinationlong" value="<%= currenttrip.end_location.lng %>" class="form-control">
            
                	<button id="carpooling_create" class="col-xs-12 btn btn-primary btn-warning btn-big" type="submit">Offer this ride</button>
                	<button id="carpooling_join" class="col-xs-12 btn btn-primary btn-big hidden" type="submit">Join this ride</button>
            	<% } %>
        	</div>
        </form>
    </div>

    
    <hr>
    
    <div class="row">
      <div  class="col-xs-12">
        <div id="map"></div>
      </div>
    </div>
    
    <script>
 
          function initMap() {
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer;
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 3,
                center: {
                    lat: 61.9241,
                    lng: 25.7482
                }
            });
            directionsDisplay.setMap(map);
            
            //console.log();
            //var mapdata = ;
            //console.log("Server:");
            //console.log(mapdata.result);
            //var parsedresponse = JSON.parse('');
            //console.log(parsedresponse);
            //directionsDisplay.setDirections( mapdata.result );
    
            var onChangeHandler = function() {
                calculateAndDisplayRoute(directionsService, directionsDisplay);
            };
            document.getElementById('tripslist').addEventListener('change', onChangeHandler);
            //document.getElementById('end').addEventListener('change', onChangeHandler);
    
            calculateAndDisplayRoute(directionsService, directionsDisplay);
        }
    
        function calculateAndDisplayRoute(directionsService, directionsDisplay, position) {

            var tripvalue = document.getElementById('tripslist').gps;
            if (tripvalue && tripvalue!="")
            {
                var tripdata = tripvalue.split(";");
                
                var origingps = tripdata[0];
                //new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                var destinationgps = tripdata[1];
                //new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                
                
                directionsService.route({
                    origin: origingps,
                    destination: destinationgps,
                    travelMode: "<%= travelmode || 'DRIVING' %>"
                }, function(response, status) {
                    if (status === 'OK') {
                        directionsDisplay.setDirections(response);
                        //console.log("Client:");
                        //console.log(response);
                    }
                    else {
                        window.alert('Directions request failed due to ' + status);
                    }
                });
                
                
                document.getElementById('carpooling_join').classList.remove("hidden");
                document.getElementById('carpooling_create').classList.add("hidden");
                
                document.getElementById('carpooling_form').action = "carpool_join";
                //document.getElementById('carpooling_submit').innerHTML = "Join this ride";
            }
            else
            {
                directionsService.route({
                    //origin: document.getElementById('start').value,
                    //destination: document.getElementById('end').value,
                    origin: "<%= currenttrip.start_address %>",
                    destination: "<%= currenttrip.end_address %>",
                    travelMode: "<%= travelmode || 'DRIVING' %>"
                }, function(response, status) {
                    if (status === 'OK') {
                        directionsDisplay.setDirections(response);
                        //console.log("Client:");
                        //console.log(response);
                    }
                    else {
                        window.alert('Directions request failed due to ' + status);
                    }
                });
                
                document.getElementById('carpooling_join').classList.add("hidden");
                document.getElementById('carpooling_create').classList.remove("hidden");
                
                document.getElementById('carpooling_form').action = "carpool_new";
                //document.getElementById('carpooling_submit').innerHTML = "Share this ride";
            }
        }
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=<%= googlemapskey %>&callback=initMap">
    </script>

</div>
